"use strict";var global=require("./global.js");var fs=require("fs");var exec=require("child_process").exec,child;var SYS_STAT="/var/conwin/ram/system.stat";var SYS_LOG="/var/conwin/system.log";var EVENT_LOG="/var/conwin/event.log";var Q_TTYS0="/var/conwin/ttys0.q";var serial_dev="/dev/ttyS0";var LF=String.fromCharCode(10);var CR=String.fromCharCode(13);var SO=String.fromCharCode(14);var ACK=String.fromCharCode(6);var NAK=String.fromCharCode(21);var DRVNAME=new Buffer([180,212,206,196,205,248,194,231,177,168,190,175]);function IPR_Server(config){this.config=config;this.ttys0_state="idle";this.ttys0_buf="";this.ttys0_cmd="";this.q_ttys0_event=[];this.q_ttys0_status=[];this.q_ttys0_changed=false;this.event_log=[];this.event_log_changed=false;this.resend_timer=null;this.report_seq=0;this.daemons=[];this.serial_fail=false;this.net_fail=false;this.sessions=[];this.ignore_ack=0;this.ttys0_idle=30}IPR_Server.prototype.update_session_list=function(){var t1=new Date;this.sessions=[];for(var i=0;i<this.daemons.length;i++){var daemon=this.daemons[i];this.sessions=this.sessions.concat(daemon.sessions_list())}var tids=[];var cnt=100;var i=0;var sss=[];while(i<this.sessions.length&&cnt>0){var session=this.sessions[i];var tid=session.runtime.profile.tid;var model=session.runtime.profile.model;if(tid&&!model){sss.push({session:session,tid:tid});tids.push(tid);cnt--}i++}if(tids.length>0){var http=require("http");var tid=this.config.cwcdn.TID;var url="http://cos.conwin.cn/tid/m?"+"tid="+tid+"&tids="+tids.join(";");url=url;http.get(url,function(res){var data="";res.on("data",function(trunk){data=data+trunk}.bind(this));res.on("end",function(){try{var result=JSON.parse(data);for(var i=0;i<result.length;i++){var r=result[i];for(var j=0;j<sss.length;j++){var ss=sss[j];if(ss.tid===r.tid){ss.session.runtime.profile.model=r.model}}}}catch(error){}}.bind(this))}.bind(this))}var t2=new Date;if(t2-t1>100){this.log("[update session list]: length=",this.sessions.length,"time cost:",t2-t1,"ms")}};IPR_Server.prototype.write_q_file=function(){var data;if(this.event_log_changed){data=this.event_log.join("\n");if(this.event_log.length>0){data=data+"\n"}fs.writeFile(EVENT_LOG,data);this.event_log_changed=false}if(this.q_ttys0_changed){data=this.q_ttys0_event.join("\n");if(this.q_ttys0_event.length>0){data=data+"\n"}fs.writeFile(Q_TTYS0,data);this.q_ttys0_changed=false}};IPR_Server.prototype.log_event=function(daemon,session,event){var s="";s=s+event.time.format()+";";s=s+daemon.line()+";";s=s+event.cid+";";s=s+event.eid+";";s=s+daemon.protocol()+";";s=s+daemon.port()+";";s=s+session.ip()+";";s=s+session.sn()+";";this.event_log.push(s);if(this.event_log.length>=1e4){this.event_log.shift()}this.event_log_changed=true};IPR_Server.prototype.on_info_event=function(daemon,session,event){this.set_net_fail(false);if(this.config.ipr["log-online-offline"]){this.log_event(daemon,session,event)}if(this.config.ipr["report-online-offline"]){this.q_status_event(daemon,event)}};IPR_Server.prototype.on_stat_report=function(daemon,session,report){var format=this.config.ipr["serial-format"];if(format!=="conwin"){return}var acct=session.acct();while(acct.length<8){acct="0"+acct}var report1="#8"+this.report_seq+";"+acct+" ";fs.appendFileSync(serial_dev,LF+report1);fs.appendFileSync(serial_dev,DRVNAME);var report2=";1;"+new Buffer("report,"+report).toString("base64");fs.appendFileSync(serial_dev,report2+SO);this.report_seq++;this.log("report: ["+report1+DRVNAME+report2+"]")};IPR_Server.prototype.on_cid_event=function(daemon,session,event){this.set_net_fail(false);this.log("[cid event]",event.cid);this.log_event(daemon,session,event);var format=this.config.ipr["serial-format"];if(format==="685"){var caller=event.caller;if(caller){this.q_ttys0_event.push(daemon.line()+" "+session.acct().substr(-4)+caller.substring(caller.length-10))}this.q_ttys0_event.push(daemon.line()+" "+event.cid)}else if(format==="conwin"){var s=daemon.line()+" "+event.cid;if(event.caller){s=s+"#1"+event.caller+","}if(event.time){s=s+"#2"+event.time.format()+","}s=s+"#3"+this.surfix(daemon);if(event.eid){s=s+"#4"+event.eid+","}this.q_ttys0_event.push(s)}else{this.log("ERROR: unknown serial format:",format)}this.q_ttys0_changed=true;this.process_ttys0_q()};function uptime(){var t=fs.readFileSync("/proc/uptime").toString().split(" ")[0];var day=Math.trunc(t/86400);var hours=Math.trunc(t%86400/3600);var minutes=Math.trunc(t%3600/60);var seconds=Math.trunc(t%60);var result="";if(day){result=result+day+" 天 "}if(hours){result=result+hours+" 小时 "}if(minutes){result=result+minutes+" 分 "}if(seconds){result=result+seconds+" 秒"}return result}IPR_Server.prototype.get_runtime=function(index,callback){if(typeof callback!=="function"){return}var r={};r["sys-uptime"]=uptime();r["sys-time"]=(new Date).format();r["sys-model"]=this.config.cwcdn.MODEL;r["sys-sn"]=this.config.cwcdn.TID;r["sys-version"]=this.config.cwcdn.VERSION;r["sys-os"]="linux "+fs.readFileSync("/proc/version").toString().split(" ")[2];r["sys-serial-fail"]=this.serial_fail;r["sys-network-fail"]=this.net_fail;r["total-online"]=this.sessions.length;r["sessions"]=[];var end=index+100;if(end>this.sessions.length){end=this.sessions.length}for(var i=index;i<end;i++){var ss=this.sessions[i];r["sessions"].push({order:i,line:ss.daemon.line(),protocol:ss.daemon.protocol(),port:ss.daemon.port(),acct:ss.acct(),model:ss.model(),sn:ss.sn(),ip:ss.ip(),uptime:ss.uptime.format()})}callback(r)};IPR_Server.prototype.surfix=function(daemon){return this.config.cwcdn.MODEL+"-"+this.config.ipr["reciver-number"]};IPR_Server.prototype.q_status_event=function(daemon,event){var format=this.config.ipr["serial-format"];if(format==="685"){if(this.config.ipr["panel-event-first"]){this.q_ttys0_status.push(daemon.line()+" "+event.cid)}else{this.q_ttys0_event.push(daemon.line()+" "+event.cid)}}else if(format==="conwin"){var s=daemon.line()+" "+event.cid;if(event.caller){s=s+"#1"+event.caller+","}if(event.time){s=s+"#2"+event.time.format()+","}s=s+"#3"+this.surfix(daemon);if(event.eid){s=s+"#4"+event.eid+","}if(this.config.ipr["panel-event-first"]){this.q_ttys0_status.push(s)}else{this.q_ttys0_event.push(s)}}else{this.log("ERROR: unknown serial format:",format)}this.process_ttys0_q()};IPR_Server.prototype.send_all_connection_status=function(){for(var i=0;i<this.daemons.length;i++){var daemon=this.daemons[i];var list=daemon.get_all_session_status();for(var i=0;i<list.length;i++){this.q_status_event(daemon,list[i])}}};IPR_Server.prototype.process_ttys0_q=function(){if(this.q_ttys0_event.length===0&&this.q_ttys0_status.length===0){return}if(this.ttys0_state!=="idle"){return}var msg="";if(this.q_ttys0_event.length>0){msg=this.q_ttys0_event[0]}else if(this.q_ttys0_status.length>0){msg=this.q_ttys0_status[0]}msg=LF+this.config.ipr["reciver-number"]+msg+CR;this.log("send out: ",msg);fs.appendFileSync(serial_dev,msg);this.ttys0_state="wait-ack";this.resend_timer=setTimeout(function(){this.ttys0_state="idle";this.process_ttys0_q()}.bind(this),5e3)};IPR_Server.prototype.parse_ttys0_cmd=function(cmd,param){var cmd_xref_table={1:"away",2:"open",3:"bypass",5:"unbypass",6:"stay",8:"get",17:"pwd"};cmd=cmd_xref_table[cmd];param=param.split(",");var result=null;switch(cmd){case"away":case"stay":case"open":result=cmd;result=result+","+param[2];result=result+(param[0]?","+param[0]:"");break;case"bypass":case"unbypass":result=cmd;result=result+","+param[2];result=result+","+param[1];break;case"pwd":result=cmd;result=result+","+param[0];result=result+","+param[3];result=result+","+param[2];result=result+":"+param[1];break;case"get":result=cmd+",status,all"}return result};IPR_Server.prototype.get_sessions_of=function(acct){var result=[];for(var i=0;i<this.daemons.length;i++){var daemon=this.daemons[i];result=result.concat(daemon.get_sessions_of(acct))}return result};IPR_Server.prototype.on_ttys0_cmd=function(command){if(command.substring(0,2)!=="#7"){return}if(!this.config.ipr["allow-control-device"]){return}command=command.substring(2).split(" ");var acct=parseInt(command.shift(),16);var cmd=command.shift();var param=command.join(" ");cmd=this.parse_ttys0_cmd(cmd,param);var sessions=this.get_sessions_of(acct);if(sessions.length>0){var level_max=1e4;for(var i=0;i<sessions.length;i++){if(sessions[i].runtime.level<level_max){level_max=sessions[i].runtime.level}}this.log("level max = ",level_max);var level=sessions[0].level();for(var i=0;i<sessions.length;i++){var session=sessions[i];if(session.level()===level_max){this.log("[cmd send to]",session.runtime.tcp.raddr,cmd);session.send_cmd(cmd)}}}};IPR_Server.prototype.on_ttys0_data=function(data){this.ttys0_idle=0;this.ttys0_buf=this.ttys0_buf+data.toString();while(this.ttys0_buf.length>0){var ch=this.ttys0_buf[0];this.ttys0_buf=this.ttys0_buf.substring(1);if(ch===ACK){if(this.ignore_ack>0){this.ignore_ack--}else{if(this.resend_timer){clearTimeout(this.resend_timer);this.resend_timer=null}if(this.ttys0_state==="wait-ack"){if(this.q_ttys0_event.length>0){this.q_ttys0_event.shift()}else if(this.q_ttys0_status.length>0){this.q_ttys0_status.shift()}this.q_ttys0_changed=true;this.ttys0_state="idle";this.process_ttys0_q()}}}else if(ch===NAK){if(this.resend_timer){clearTimeout(this.resend_timer);this.resend_timer=null}if(this.ttys0_state==="wait-ack"){this.ttys0_state="idle";this.process_ttys0_q()}}else if(ch==="S"){fs.appendFileSync(serial_dev,LF+"00 OKAY @"+CR);this.ignore_ack++}else if(ch==="G"){this.send_all_connection_status()}else if(ch===LF){this.ttys0_cmd=""}else if(ch===CR){this.on_ttys0_cmd(this.ttys0_cmd);this.ttys0_cmd=""}else{this.ttys0_cmd=this.ttys0_cmd+ch}}};IPR_Server.prototype.write_system_status=function(){var r={};r["sys-uptime"]=uptime();r["sys-time"]=(new Date).format();r["sys-model"]=this.config.cwcdn.MODEL;r["sys-sn"]=this.config.cwcdn.TID;r["sys-version"]=this.config.cwcdn.VERSION;r["sys-os"]="linux "+fs.readFileSync("/proc/version").toString().split(" ")[2];r["sys-serial-fail"]=this.serial_fail;r["sys-network-fail"]=this.net_fail;r["total-online"]=this.sessions.length;var stat="";for(var key in r){if(!r.hasOwnProperty(key)){continue}stat=stat+key.toUpperCase()+"="+r[key].toString()+"\n"}fs.writeFileSync(SYS_STAT,stat)};IPR_Server.prototype.load_data=function(){try{fs.accessSync(EVENT_LOG,fs.F_OK);var data=fs.readFileSync(EVENT_LOG).toString();if(data.length>0){data=data.substring(0,data.length-1);this.event_log=data.split("\n")}}catch(error){}try{fs.accessSync(Q_TTYS0,fs.F_OK);var data=fs.readFileSync(Q_TTYS0).toString();if(data.length>0){data=data.substring(0,data.length-1);this.q_ttys0_event=data.split("\n")}}catch(error){}};IPR_Server.prototype.create_daemon_ipr_1=function(key){var line=this.config.ipr["tcp-lines"][key];if(line.protocol!=="ipr-1"){return}if(!line.enabled){return}var Daemon=require("./daemon-ipr-1.js");var daemon=new Daemon(this,key);return daemon};IPR_Server.prototype.create_daemon_ipr_2=function(key){var line=this.config.ipr["tcp-lines"][key];if(line.protocol!=="ipr-2"){return}if(!line.enabled){return}var Daemon=require("./daemon-ipr-2.js");var daemon=new Daemon(this,key);return daemon};IPR_Server.prototype.create_daemon_phone_line=function(line){};IPR_Server.prototype.start_daemon=function(){var lines=this.config.ipr["tcp-lines"];if(!lines){this.log("No lines config for server");return}for(var key in lines){if(!lines.hasOwnProperty(key)){continue}var line=lines[key];var daemon=null;switch(line.protocol){case"ipr-1":daemon=this.create_daemon_ipr_1(key);break;case"ipr-2":daemon=this.create_daemon_ipr_2(key);break}if(daemon){this.daemons.push(daemon);daemon.on("cid-event",this.on_cid_event.bind(this));daemon.on("stat-report",this.on_stat_report.bind(this));daemon.on("info-event",this.on_info_event.bind(this));daemon.start()}}};IPR_Server.prototype.setup_serial=function(){var baud=this.config.ipr["serial-baud"];var cmd="stty -F "+serial_dev+" "+baud;this.log(cmd);var child=exec(cmd,function(error,stdout,stderr){if(error!==null){this.log("set baud error: "+cmd+" : "+error)}else{this.log(serial_dev+" baud set to: "+baud);var f=fs.createReadStream(serial_dev);f.on("data",this.on_ttys0_data.bind(this));setInterval(this.write_q_file.bind(this),3e3);if(this.q_ttys0_event.length>0){this.process_ttys0_q()}}}.bind(this));setInterval(this.serial_monitor.bind(this),1e3)};IPR_Server.prototype.serial_monitor=function(){this.ttys0_idle++;if(this.ttys0_idle>60){if(!this.serial_fail){this.log(0,"system","","","串口故障");this.write_system_status()}this.serial_fail=true}else{if(this.serial_fail){this.log(0,"system","","","串口故障恢复");this.write_system_status()}this.serial_fail=false}};IPR_Server.prototype.set_net_fail=function(fail){if(!fail){if(this.net_fail){this.log(0,"system","","","网络故障恢复");this.write_system_status()}this.net_fail=false}else{if(!this.net_fail){this.log(0,"system","","","网络故障");this.write_system_status()}this.net_fail=true}};IPR_Server.prototype.network_monitor=function(){setInterval(function(){var cmd="ping -c 1 $(route -n | awk '/^0.0.0.0/{print $2}') > /dev/null; echo $?";var child=exec(cmd,function(error,stdout,stderr){this.log("ping result",stdout);this.set_net_fail(!(stdout[0]==="0"))}.bind(this))}.bind(this),3e4)};IPR_Server.prototype.run=function(){this.log(0,"system","","","系统服务启动");this.start_daemon();this.setup_serial();this.load_data();this.network_monitor();setInterval(this.update_session_list.bind(this),1e4);setInterval(this.write_system_status.bind(this),5e3)};IPR_Server.prototype.log=function(){var level=-1;var first=0;var user,ip,port;if(typeof arguments[0]==="number"){level=arguments[0];user=arguments[1]||"";ip=arguments[2]||"";port=arguments[3]||"";first=4}var msg="";for(var i=first;i<arguments.length;i++){msg=msg+arguments[i]+" "}msg=msg.replace(/[\r]/g,"<CR>");msg=msg.replace(/[\n]/g,"<LF>");console.log((new Date).format(),"[server]",msg);if(level===0){msg=(new Date).format()+";"+user+";"+ip+";"+port+";"+msg;fs.appendFileSync(SYS_LOG,msg+"\n")}};module.exports=IPR_Server;