"use strict";var fs=require("fs");var config_file="/etc/ipr/config.json";var config_file_default="/etc/ipr/config.default.json";var config={ipr:{},cwcdn:{}};function critical_error(){process.exit(-1)}function load_config(){var cwcdn;try{cwcdn=fs.readFileSync("/etc/cwcdn.conf").toString()}catch(error){console.log("Missing cwcdn.conf");return false}var list=cwcdn.split("\n");for(var i=0;i<list.length;i++){var f=list[i].split("=");var name=f[0];f.shift();var value=f.join("=");config.cwcdn[name]=value}try{var s=fs.readFileSync(config_file);config.ipr=JSON.parse(s);return true}catch(error){console.log("Missing config file:",config_file);console.log(error)}try{var s=fs.readFileSync(config_file_default);config.ipr=JSON.parse(s);fs.writeFileSync(config_file,s);return true}catch(error){console.log("Can not restore config file to default");console.log(error)}return fasle}if(!load_config()){critical_error()}console.log("config = ",config);fs.watch(config_file,function(event,file){load_config()});var IPR=require("./server.js");var ipr=new IPR(config);ipr.run();var web=require("../web/ipr-web-main.js");web.server=ipr;var web_port=config.ipr["web-port"];web.listen(web_port,function(){console.log("web server listening on port:",web_port)});