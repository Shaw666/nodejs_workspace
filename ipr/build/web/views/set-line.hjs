<!DOCTYPE html><html lang=en>{{> header}}{{> page_header}}<div id=body-container><div id=body-content>{{> nav}}<section class="page container"><form class=form-horizontal><div class=container><div class=row><div id=server-settings-row class=span10><fieldset><legend>线路设置(修改后需要重新登录)</legend><br><div class="box pattern-sandstone span10"><div class=box-header><i class=icon-table></i><h5>接警线路列表</h5></div><div class="box-content box-table"><table class="table table-striped table-hover table-bordered tablesorter"><thead><tr><th class="center span2"><th class="center span1">是否启用<th class="center span1">线号<th class="center span2">名称<th class="center span2">用户号前缀<th class="center span2">端口<th class="center span2">协议<tbody id=lines-list></table></div></div></fieldset></div><div id=new-line-row class=span10><fieldset><legend>增加/修改线路</legend><br><div class=control-group><label class=control-label>线号</label><div class=controls><select id=new-number class=span2><option value=1>1号线路<option value=2>2号线路<option value=3>3号线路<option value=4>4号线路<option value=5>5号线路<option value=6>6号线路<option value=7>7号线路<option value=8>8号线路<option value=9>9号线路</select></div></div><div class=control-group><label class=control-label>名称</label><div class=controls><input id=new-name class=span4 autocomplete=false></div></div><div class=control-group><label class=control-label>用户号前缀<br>(留空或4位数字)</label><div class=controls><input id=new-prefix class=span4 autocomplete=false></div></div><div class=control-group><label class=control-label>端口(2000-9999)</label><div class=controls><input id=new-port class=span4 autocomplete=false></div></div><div class=control-group><label class=control-label>通信协议</label><div class=controls><select id=new-protocol class=span2><option value=ipr-2>ipr-2<option value=ipr-1>ipr-1</select></div></div><div class=control-group><div class=controls><button id=btn-add-child class="center btn" name=add-child><span class=icon-plus></span>增加线路</button> <button id=btn-edit-child class="center btn" name=add-child><span class=icon-edit></span>更新线路</button></div></div></fieldset></div></div></div></form></section></div></div>{{> footer}}<script src=../js/bootstrap/bootstrap-switch.js></script><script>$(function(){function t(t){var t=t||window.event;return t&&(t.returnValue="数据已修改"),"数据已修改"}function e(){d||(window.onbeforeunload=t)}function r(){var t=$(this).data().key;c[t];return confirm("确定要删除线路:"+t+"("+c[t].name+")吗?")&&(delete c[t],$("#row-"+t).remove(),e()),!1}function n(){var t=$(this).data().key,e=c[t];return $("#new-number").val(t),$("#new-name").val(e.name),$("#new-prefix").val(e.prefix),$("#new-port").val(e.port),$("#new-protocol").val(e.protocol),!1}function o(){var t,r=$(this).data(),n=r.key,o=c[n];t=!!$(this).attr("checked"),o.enabled!=t&&(e(),o.enabled=t,$(".switch").bootstrapSwitch())}function a(){var t=$("#new-number").val().toString(),r=$("#new-name").val(),n=$("#new-prefix").val(),o=$("#new-port").val().toString(),a=$("#new-protocol").val();if(!/^[0-9]$/.test(t))return alert(t+": 线路号格式错误."),$("#new-liine").focus(),!1;if(!/^[0-9]{4}$/.test(o))return alert("端口号格式错误:"+o),$("#new-port").focus(),!1;if(n&&!/^[0-9]{4}$/.test(n))return alert("用户号前缀格式错误:"+n),$("#new-prefix").focus(),!1;if(o=parseInt(o,10),2e3>o||o>1e4)return alert(o+": 端口号超出允许的范围"),$("#new-port").focus(),!1;for(var i in c)if(c.hasOwnProperty(i)&&c[i].port===o)return alert(o+": 端口号重复"),$("#new-port").focus(),!1;return"ipr-1"!==a&&"ipr-2"!==a?(alert(a+": 未知的协议类型"),$("#new-protocol").focus(),!1):c[t]?(alert(t+"线路已经存在."),$("#new-line").focus(),!1):(e(),c[t]={enabled:!0,name:r,prefix:n,port:o,protocol:a},void l(t,c[t]))}function i(){var t=$("#new-number").val().toString();if(!c[t])return alert(t+"线路不存在."),$("#new-line").focus(),!1;var r=$("#new-name").val(),n=$("#new-prefix").val(),o=$("#new-port").val().toString(),a=$("#new-protocol").val();if(!/^[0-9]$/.test(t))return alert(t+": 线路号格式错误."),$("#new-liine").focus(),!1;if(!/^[0-9]{4}$/.test(o))return alert("端口号格式错误:"+o),$("#new-port").focus(),!1;if(n&&!/^[0-9]{4}$/.test(n))return alert("用户号前缀格式错误:"+n),$("#new-prefix").focus(),!1;if(o=parseInt(o,10),2e3>o||o>1e4)return alert(o+": 端口号超出允许的范围"),$("#new-port").focus(),!1;for(var i in c)if(c.hasOwnProperty(i)&&i!==t&&c[i].port===o)return alert(o+": 端口号重复"),$("#new-port").focus(),!1;return"ipr-1"!==a&&"ipr-2"!==a?(alert(a+": 未知的协议类型"),$("#new-protocol").focus(),!1):(e(),c[t]={enabled:!0,name:r,prefix:n,port:o,protocol:a},void p(t))}function p(t){var e=c[t];e&&($("#row-"+t+" #col-name").text(e.name),$("#row-"+t+" #col-prefix").text(e.prefix),$("#row-"+t+" #col-port").text(e.port),$("#row-"+t+" #col-protocol").text(e.protocol))}function l(t,e){var a=$("#lines-list"),i=$("<tr>").attr("id","row-"+t),p=$("<td>").addClass("center").attr("id","col-oper").appendTo(i);$("<button>").addClass("btn").append($("<span>").addClass("icon-remove")).click(r).data({key:t,line:e}).appendTo(p),$("<button>").addClass("btn").append($("<span>").addClass("icon-edit")).click(n).data({key:t,line:e}).appendTo(p),p.appendTo(i),p=$("<td>").attr("id","col-enabled").addClass("center").appendTo(i);var l=$("<input>").attr("type","checkbox").addClass("switch").data({key:t,line:e}).addClass("span4").on("switchChange.bootstrapSwitch",o);e.enabled&&l.attr("checked","true"),l.appendTo(p),$("<td>").attr("id","col-key").addClass("center").append(t).appendTo(i),p=$("<td>").appendTo(i).attr("id","col-name").append(e.name),p=$("<td>").appendTo(i).attr("id","col-prefix").append(e.prefix),p=$("<td>").appendTo(i).attr("id","col-port").append(e.port),p=$("<td>").appendTo(i).attr("id","col-protocol").append(e.protocol),i.appendTo(a),$(".switch").bootstrapSwitch()}$.fn.bootstrapSwitch.defaults.size="small",$(".switch").bootstrapSwitch(),$("form").submit(function(){event.preventDefault()});var c={};$("#submit-confirm-button").click(function(){var t=JSON.stringify(c);if(confirm("确认保存?"))return $.getJSON("/api/set-lines?data="+t).done(function(t){return"OK"!=t.result?(alert("配置保存失败:"+JSON.stringify(t)),!1):(window.onbeforeunload=null,void alert("配置保存成功."))}).fail(function(t,e,r){alert("数据保存失败, 请重新保存.")}),!0});var d=!1;$("#btn-add-child").click(a),$("#btn-edit-child").click(i),$.getJSON("/api/get-lines",function(t){c=t;var e=$("#lines-list");e.empty();for(var r in c)if(c.hasOwnProperty(r)){var n=c[r];l(r,n)}})})</script>